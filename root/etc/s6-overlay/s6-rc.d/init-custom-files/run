#!/usr/bin/with-contenv bash

# Directories
SCRIPTS_DIR_OLD="/config/custom-cont-init.d"
SERVICES_DIR_OLD="/config/custom-services.d"
SCRIPTS_DIR="/custom-cont-init.d"
SERVICES_DIR="/custom-services.d"

# chown legacy folders if they exist
if [ -e "${SCRIPTS_DIR_OLD}" ]; then
    chown -R 0:0 "${SCRIPTS_DIR_OLD}"
fi

if [ -e "${SERVICES_DIR_OLD}" ]; then
    chown -R 0:0 "${SERVICES_DIR_OLD}"
fi

# Remove all existing custom services before continuing to ensure
# we aren't running anything the user may have removed
if [ -n "$(/bin/ls -A /etc/services.d/custom-service-* 2>/dev/null)" ]; then
    echo "[custom-init] removing existing custom services..."
    rm -rf /etc/services.d/custom-service-*
fi

if { [ -z "$(/bin/ls -A ${SCRIPTS_DIR} 2>/dev/null)" ]; } && \
    { [ -z "$(/bin/ls -A ${SERVICES_DIR} 2>/dev/null)" ]; } && \
    { [ -z "$(/bin/ls -A ${SCRIPTS_DIR_OLD} 2>/dev/null)" ]; } && \
    { [ -z "$(/bin/ls -A ${SERVICES_DIR_OLD} 2>/dev/null)" ]; }; then    
    echo "[custom-init] no custom files found, exiting..."
    exit 0
fi

# Make sure custom init directory exists and has files in it
if { [ -e "${SCRIPTS_DIR}" ] && [ -n "$(/bin/ls -A ${SCRIPTS_DIR} 2>/dev/null)" ]; } || \
    { [ -e "${SERVICES_DIR}" ] && [ -n "$(/bin/ls -A ${SERVICES_DIR} 2>/dev/null)" ]; }; then
    if [ -n "$(/bin/ls -A ${SCRIPTS_DIR} 2>/dev/null)" ]; then
      echo "[custom-init] files found, executing"
      for SCRIPT in ${SCRIPTS_DIR}/*; do
        NAME="$(basename "${SCRIPT}")"
        if [ -f "${SCRIPT}" ]; then
          echo "[custom-init] ${NAME}: executing..."
          /bin/bash "${SCRIPT}"
          echo "[custom-init] ${NAME}: exited $?"
        elif [ ! -f "${SCRIPT}" ]; then
          echo "[custom-init] ${NAME}: is not a file"
        fi
      done
    fi
    if [ -n "$(/bin/ls -A ${SERVICES_DIR} 2>/dev/null)" ]; then
      echo "[custom-init] service files found in ${SERVICES_DIR}"
      for SERVICE in ${SERVICES_DIR}/*; do
        NAME="$(basename "${SERVICE}")"
        if [ -f "${SERVICE}" ]; then
          echo "[custom-init] ${NAME}: service detected, copying..."
          mkdir -p /etc/services.d/custom-service-"${NAME}"/
          cp "${SERVICE}" /etc/services.d/custom-service-"${NAME}"/run
          chmod +x /etc/services.d/custom-service-"${NAME}"/run
          echo "[custom-init] ${NAME}: copied"
        elif [ ! -f "${SERVICE}" ]; then
          echo "[custom-init] ${NAME}: is not a file"
        fi
      done
    fi
fi

if { [ -e "${SCRIPTS_DIR_OLD}" ] && [ -n "$(/bin/ls -A ${SCRIPTS_DIR_OLD} 2>/dev/null)" ]; } || \
    { [ -e "${SERVICES_DIR_OLD}" ] && [ -n "$(/bin/ls -A ${SERVICES_DIR_OLD} 2>/dev/null)" ]; }; then
    if [ -n "$(/bin/ls -A ${SCRIPTS_DIR_OLD} 2>/dev/null)" ]; then
      echo "[custom-init] files found, executing"
      for SCRIPT in ${SCRIPTS_DIR_OLD}/*; do
        NAME="$(basename "${SCRIPT}")"
        if [ -f "${SCRIPT}" ]; then
          echo "[custom-init] ${NAME}: executing..."
          /bin/bash "${SCRIPT}"
          echo "[custom-init] ${NAME}: exited $?"
        elif [ ! -f "${SCRIPT}" ]; then
          echo "[custom-init] ${NAME}: is not a file"
        fi
      done
    fi
    if [ -n "$(/bin/ls -A ${SERVICES_DIR_OLD} 2>/dev/null)" ]; then
      echo "[custom-init] service files found in ${SERVICES_DIR_OLD}"
      for SERVICE in ${SERVICES_DIR_OLD}/*; do
        NAME="$(basename "${SERVICE}")"
        if [ -f "${SERVICE}" ]; then
          echo "[custom-init] ${NAME}: service detected, copying..."
          mkdir -p /etc/services.d/custom-service-"${NAME}"/
          cp "${SERVICE}" /etc/services.d/custom-service-"${NAME}"/run
          chmod +x /etc/services.d/custom-service-"${NAME}"/run
          echo "[custom-init] ${NAME}: copied"
        elif [ ! -f "${SERVICE}" ]; then
          echo "[custom-init] ${NAME}: is not a file"
        fi
      done
    fi 
fi
